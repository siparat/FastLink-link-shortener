<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>
		Переход по короткой ссылке | FastLink
	</title>
	<link rel="shortcut icon"
		href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxnIGNsaXAtcGF0aD0idXJsKCNjbGlwMF8xMDhfMTAxNSkiPgo8cGF0aCBkPSJNMTgzLjkgMTYuMUMxNjIuNSAtNS4zMDAwMSAxMjcuNyAtNS4zMDAwMSAxMDYuMyAxNi4xTDgyLjIgNDAuMUM5Mi45IDM5LjEgMTAzLjcgNDAuNCAxMTMuOSA0NC4yTDEyNC4yIDMzLjlDMTM1LjcgMjIuNCAxNTQuNSAyMi40IDE2Ni4xIDMzLjlDMTc3LjYgNDUuNCAxNzcuNiA2NC4yIDE2Ni4xIDc1LjhMMTMxLjggMTEwLjFDMTIwLjMgMTIxLjYgMTAxLjUgMTIxLjYgODkuOSAxMTAuMUM4Ni42IDEwNi44IDg0LjMgMTAzIDgyLjkgOTguOUM4MS43IDk5LjUgODAuNyAxMDAuMyA3OS43IDEwMS4zTDYzLjcgMTE3LjNDNjYgMTIxLjEgNjguNyAxMjQuNyA3MiAxMjhDOTMuNCAxNDkuNCAxMjguMiAxNDkuNCAxNDkuNiAxMjhMMTgzLjkgOTMuN0MyMDUuNCA3Mi4zIDIwNS40IDM3LjUgMTgzLjkgMTYuMVoiIGZpbGw9IiMxRjU3RTciLz4KPHBhdGggZD0iTTg2LjUgMTU1LjRMNzUuOCAxNjYuMUM2NC4zIDE3Ny42IDQ1LjUgMTc3LjYgMzMuOSAxNjYuMUMyMi40IDE1NC42IDIyLjQgMTM1LjggMzMuOSAxMjQuMkw2OC4yIDg5LjlDNzkuNyA3OC40IDk4LjUgNzguNCAxMTAuMSA4OS45QzExMy41IDkzLjMgMTE1LjkgOTcuMyAxMTcuMyAxMDEuNUMxMTguNSAxMDAuOSAxMTkuNyAxMDAgMTIwLjcgOTlMMTM2LjYgODMuMUMxMzQuMyA3OS4xIDEzMS40IDc1LjQgMTI4IDcyQzEwNi42IDUwLjYgNzEuOCA1MC42IDUwLjQgNzJMMTYuMSAxMDYuM0MtNS4zMDAwMSAxMjcuNyAtNS4zMDAwMSAxNjIuNSAxNi4xIDE4My45QzM3LjUgMjA1LjMgNzIuMyAyMDUuMyA5My43IDE4My45TDExOC40IDE1OS4yQzEwNy42IDE2MC40IDk2LjcgMTU5LjEgODYuNSAxNTUuNFoiIGZpbGw9IiMxRjU3RTciLz4KPC9nPgo8ZGVmcz4KPGNsaXBQYXRoIGlkPSJjbGlwMF8xMDhfMTAxNSI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSJ3aGl0ZSIvPgo8L2NsaXBQYXRoPgo8L2RlZnM+Cjwvc3ZnPgo=">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="/styles.css">
</head>

<body>
	<div class="container">
		<h1>
			FastLink – Сокращатель ссылок
		</h1>
		<div id="auth" class="buttons">
			<button data-modal-id="register" style="--color: #2F69FE">
				<p class="p_medium">Регистрация</p>
			</button>
			<button data-modal-id="login" class="transparent" style="--color: #2F69FE">
				<p class="p_medium">Вход</p>
			</button>
		</div>
		<div class="hidden" id="main">
			<form action="/create" class="form">
				<input name="url" placeholder="Ссылка" type="text">
				<div class="length">
					<div class="length__wrapper">
						<p class="p_small">Длина строки</p>
						<p id="length__count" class="p_small">6</p>
					</div>
					<input name="length" value="6" min="6" max="25" type="range">
				</div>
				<p id="result" class="p_medium hidden"></p>
				<p id="info" class="p_small hidden">Ссылка скопирована в буфер обмена</p>
				<p class="p_small error"></p>
				<button type="button" class="short" style="--color: #2F69FE">
					<p class="p_medium">Сократить</p>
				</button>
			</form>
		</div>

		<dialog id="register" class="modal">
			<div class="modal__block">
				<h1>Регистрация</h1>
				<form action="/auth/register" class="form">
					<input placeholder="Почта" name="email" type="email">
					<input placeholder="Никнейм" name="nickname" type="text">
					<input placeholder="Пароль" name="password" type="password">
					<button class="short" style="--color: #2F69FE">
						<p class="p_small">Регистрация</p>
					</button>
					<p class="p_small error"></p>
				</form>
			</div>
		</dialog>

		<dialog id="login" class="modal">
			<div class="modal__block">
				<h1>Вход</h1>
				<form action="/auth/login" class="form">
					<input placeholder="Почта" name="email" type="email">
					<input placeholder="Пароль" name="password" type="password">
					<button class="short" style="--color: #2F69FE">
						<p class="p_small">Вход</p>
					</button>
					<p class="p_small error"></p>
				</form>
			</div>
		</dialog>
	</div>

	<script>
		const rangeCount = document.getElementById('length__count');
		const mainForm = document.querySelector('#main form');

		const getBody = (target) => {
			return new FormData(target).entries().reduce((acc, curr) => {
				acc[curr[0]] = curr[1]
				return acc
			}, {})
		}

		const isError = (obj) => 'message' in obj && 'statusCode' in obj

		const connectAuthToken = (headers) => ({...headers, Authorization: `Bearer ${localStorage.getItem('accessToken')}`})

		window.addEventListener('load', () => {
			if (!localStorage.getItem('accessToken')) {
				return;
			}
			document.getElementById('auth').classList.add('hidden')
			document.getElementById('main').classList.remove('hidden')
		})

		document.querySelectorAll('dialog').forEach(d => d.addEventListener('click', (e) => {
			e.target == e.currentTarget && e.currentTarget.close();
		}))

		document.querySelectorAll('.buttons button').forEach(btn => {
			btn.addEventListener('click', (e) => document.querySelector(`dialog#${e.currentTarget.getAttribute('data-modal-id')}`).showModal())
		})

		document.querySelectorAll('dialog form').forEach(f => f.addEventListener('submit', async (e) => {
			e.preventDefault()
			const body = getBody(e.target)
			const res = await fetch(e.target.action, { method: 'post', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
			const json = await res.json();
			if (isError(json)) {
				return e.target.querySelector('.error').innerText = Array.isArray(json.message) ? json.message[0] : json.message
			}
			localStorage.setItem('accessToken', json.accessToken)
			window.navigation.reload()
		}))

		mainForm.addEventListener('submit', (e) => {
			e.preventDefault()
		})
		
		mainForm.querySelector('button').addEventListener('click', async (e) => {
			e.preventDefault()
			const errorElement = mainForm.querySelector('.error')
			const resultElement = mainForm.querySelector('#result')
			const infoElement = mainForm.querySelector('#info')
			errorElement.innerText = ''
			resultElement.classList.add('hidden')
			infoElement.classList.add('hidden')
			const queries = new URLSearchParams(new FormData(mainForm)).toString()
			const res = await fetch(`${mainForm.action}?${queries}`, { method: 'post', headers: connectAuthToken() })
			const json = await res.json();
			if (isError(json)) {
				return errorElement.innerText = json.message;
			}
			resultElement.classList.remove('hidden')
			infoElement.classList.remove('hidden')
			resultElement.innerText = json.shortUrl;
			window.navigator.clipboard.writeText(json.shortUrl)
		})

		document.querySelector('input[type="range"]').addEventListener('input', (e) => {
			rangeCount.innerText = e.target.value;
		})

	</script>
</body>

</html>